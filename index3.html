<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">
  <script src="https://www.gstatic.com/firebasejs/7.14.4/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.14.4/firebase-firestore.js"></script>

  <title>DEMS</title>

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" type="text/css" />
  <link href="https://unpkg.com/gijgo@1.9.13/css/gijgo.min.css" rel="stylesheet" type="text/css" />
  <link href="/Content/demo.css" rel="stylesheet" type="text/css" />
  <!-- Bootstrap core CSS -->
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom styles for this template -->
  <link href="css/simple-sidebar.css" rel="stylesheet">

</head>

<body>
  <div class="d-flex" id="wrapper">

    <!-- Sidebar -->
    <div class="bg-light border-right" id="sidebar-wrapper">
      <div class="sidebar-heading">DEMS </div>
      <p>&nbsp&nbsp&nbsp&nbsp&nbspDormitory union Equipment<br>&nbsp&nbsp&nbsp&nbsp&nbspManagement System</p>

      <div class="list-group list-group-flush">
        <a href="./index.html" class="list-group-item list-group-item-action bg-dark active">물품관리 내역</a>
        <a href="./list.html" class="list-group-item list-group-item-action bg-light">물품 리스트</a>
        <a href="./location.html" class="list-group-item list-group-item-action bg-light">물품 위치</a>
        <a href="https://docs.google.com/document/d/1VwoDJ7murXERp40NkSfLysPulMXHkHMSxEZ_gIiRA4s/edit?usp=sharing" target="blank" class="list-group-item list-group-item-action bg-light">매뉴얼</a>
      </div>
    </div>
    <!-- /#sidebar-wrapper -->

    <!-- Page Content -->
    <div id="page-content-wrapper">

      <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
        <!-- <button class="btn btn-primary" id="menu-toggle">Menu</button> -->

        <div>
          <button id="btnAdd" class="button_base btn_electric">추가</button>
        </div>

        <div class="text_title">
          <p>&nbsp&nbsp&nbsp 물품관리 내역 </p>
        </div>

        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav ml-auto mt-2 mt-lg-0">
            <form class="form-inline ml-auto">
              <div class="input-group">
                <input id="txtName" type="text" class="form-control border-dark" placeholder="Search">
                <div class="input-group-append">
                  <button id="btnSearch" class="btn btn-outline-secondary" type="button"><i class="fa fa-search"></i>Enter</button>
                  <button id="btnClear" class="btn btn-outline-secondary" type="button"><i class="fa fa-search"></i>Reset</button>
                </div>
              </div>
            </form>
          </ul>
        </div>
      </nav>
      <!-- Editable table -->
      <div class="gj-clear-both"></div>
      <div class="gj-margin-top-10">
        <table id="grid"></table>
      </div>

      <div id="dialog" class="gj-display-none">
        <div data-role="body">
          <input type="hidden" id="ID" />
          <div class="">
            <input type="text" class="gj-textbox-md" id="Name" placeholder="이름...">
          </div>
          <div class="gj-margin-top-20">
            <input type="text" class="gj-textbox-md" id="SID" placeholder="학번..." />
          </div>
          <div class="">
            <input type="text" class="gj-textbox-md" id="PNum" placeholder="휴대폰번호...">
          </div>
          <div class="">
            <input type="text" class="gj-textbox-md" id="Item" placeholder="물품...">
          </div>
          <div class="">
            <input type="text" class="gj-textbox-md" id="Get" placeholder="빌린날짜...">
          </div>
          <div class="">
            <input type="text" class="gj-textbox-md" id="Back" placeholder="반납날짜...">
          </div>
          <div class="">
            <input type="text" class="gj-textbox-md" id="Remain" placeholder="남은일수...">
          </div>
          <div class="">
            <input type="text" class="gj-textbox-md" id="Status" placeholder="반납상태...">
          </div>
        </div>

        <div data-role="footer">
          <button type="button" id="btnSave" class="gj-button-md">Save</button>
          <button type="button" id="btnCancel" class="gj-button-md">Cancel</button>
        </div>
      </div>

      <div id="dialog2" class="gj-display-none">
        <div data-role="body">
          <input type="hidden" id="ID" />
          <div class="">
            <input type="text" class="gj-textbox-md" id="Admin" placeholder="담당자이름...">
          </div>
          <div class="gj-margin-top-20">
            <input type="text" class="gj-textbox-md" id="Etc" placeholder="비고..." />
          </div>
        </div>

        <div data-role="footer">
          <button type="button" id="btnSave" class="gj-button-md">Save</button>
          <button type="button" id="btnCancel" class="gj-button-md">Cancel</button>
        </div>
      </div>
      <!-- Editable table -->
      <!-- /#page-content-wrapper -->
    </div>
  </div>
  <!-- /#wrapper -->

  <!-- Footer -->
  <footer class="page-footer font-small blue">
    <div class="footer-copyright text-center py-3">© 2020 Copyright:
      SE_Spring_Group2
    </div>
  </footer>
  <!-- Footer -->

  <!-- Call JavaScript -->
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://unpkg.com/gijgo@1.9.13/js/gijgo.min.js" type="text/javascript"></script>
  <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script type="text/javascript" src="./vendor/jquery/checkbox.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.14.4/firebase-analytics.js"></script>

  <!-- Menu Toggle Script -->
  <script>
    $("#menu-toggle").click(function(e) {
      e.preventDefault();
      $("#wrapper").toggleClass("toggled");
    });

    const $td = $(this).find('td');
    const h = {};
  </script>
  <script type="text/javascript">
    $(document).ready(function () {
    var grid, dialog;
    var data = [];

    var firebaseConfig = {
      apiKey: "AIzaSyAqwpkJRTaDGkSFcRcc8kx2f6M5foeEFEE",
      authDomain: "dems-2a183.firebaseapp.com",
      databaseURL: "https://dems-2a183.firebaseio.com",
      projectId: "dems-2a183",
      storageBucket: "dems-2a183.appspot.com",
      messagingSenderId: "554123402821",
      appId: "1:554123402821:web:12cd312639412b240d8d2c",
      measurementId: "G-PKCJ378JY8"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();
    const db = firebase.firestore();      
    
    function date_to_str(format){
      var year = format.getFullYear();
      var month = format.getMonth() + 1;
      if(month<10) month = '0' + month;
      var date = format.getDate();
      if(date<10) date = '0' + date;
      return year + "-" + month + "-" + date;
    }

    db.collection('대여및반납').orderBy('Status', 'asc').onSnapshot((snapshot) => {
      let changes = snapshot.docChanges();
      changes.forEach(change => {
        if(change.type == 'added'){
          var getTimestamp = change.doc.data().Get.toMillis();
          var getDate = new Date(getTimestamp);
          var get = date_to_str(getDate);
          var back;

          var remain;
          if(change.doc.data().Status == '미납' ){
            remain = Math.ceil((Date.now()/1000 - change.doc.data().Get.seconds)/216000);
            back = "";
          }
          else{
            var backTimestamp = change.doc.data().Back.toMillis();
            var backDate = new Date(backTimestamp);
            remain = 0;
            back = date_to_str(backDate);
          }

          data.push({ 'ID': change.doc.id, 'Name': change.doc.data().Name, 'SID': change.doc.data().SID, 'PNum': change.doc.data().PNum, 'Item': change.doc.data().Item, 'Get': get, 'Back': back, 'Remain': remain,'Status': change.doc.data().Status});
          
          // var d = [];
          // d.push({ 'ID': change.doc.id, 'Name': change.doc.data().Name, 'SID': change.doc.data().SID, 'PNum': change.doc.data().PNum, 'Item': change.doc.data().Item, 'Get': change.doc.data().Get, 'Back': change.doc.data().Back, 'Remain': change.doc.data().Reamin,'Status': change.doc.data().Status});
          // buildGrid();
          // productList.appendChild(d);
        }
      })

      grid = $('#grid').grid({
        primaryKey: 'ID',
        dataSource: data,
        columns: [
        { field: 'ID', width: 56 },
        { field: 'Name', width: 100, title: '이름', align: 'center', sortable: true },
        { field: 'SID', title: '학번', align: 'center', sortable: true },
        { field: 'PNum', width: 150, title: '휴대폰번호', align: 'center', sortable: true },
        { field: 'Item', width: 150, title: '물품', align: 'center', sortable: true },
        { field: 'Get', title: '빌린날짜', align: 'center', sortable: true },
        { field: 'Back', title: '반납날짜', align: 'center', sortable: true },
        { field: 'Remain', title: '남은일수', align: 'center', sortable: true },
        { field: 'Status', title: '반납상태', align: 'center', sortable: true },
        { width: 64, tmpl: '<span class="material-icons gj-cursor-pointer">check</span>', align: 'center', events: { 'click': Check } },
        { width: 64, tmpl: '<span class="material-icons gj-cursor-pointer">edit</span>', align: 'center', events: { 'click': Edit } },
        { width: 64, tmpl: '<span class="material-icons gj-cursor-pointer">delete</span>', align: 'center', events: { 'click': Delete } }
        ],
        pager: { limit: 5 }
      });
      dialog = $('#dialog').dialog({
        autoOpen: false,
        resizable: false,
        modal: true,
        width: 360
      });

      dialog2 = $('#dialog2').dialog({
        autoOpen: false,
        resizable: false,
        modal: true,
        width: 360
      });

      function Check(e) {
        $('#Admin').val('');
        $('#Etc').val('');
        dialog2.open('Check');
      }

      function Edit(e) {
        $('#ID').val(e.data.id);
        $('#Name').val(e.data.record.Name);
        $('#SID').val(e.data.record.SID);
        $('#PNum').val(e.data.record.PNum);
        $('#Item').val(e.data.record.Item);
        $('#Get').val(e.data.record.Get);
        $('#Back').val(e.data.record.Back);
        $('#Remain').val(e.data.record.Remain);
        $('#Status').val(e.data.record.Status);
        dialog.open('Edit');
      }
      function Delete(e) {
        if (confirm('Are you sure?')) {
          db.collection('대여및반납').doc(e.data.id.toString()).delete();
          grid.removeRow(e.data.id);
        }
      }
      function Save() {
        if ($('#ID').val()) {
          var id = parseInt($('#ID').val());
          db.collection('대여및반납').doc(id.toString()).set({
            Name: $('#Name').val(),
            SID: Number($('#SID').val()),
            PNum: $('#PNum').val(),
            Item: $('#Item').val(),
            Get: $('#Get').val(),
            Back: $('#Back').val(),
            Remain: Number($('#Remain').val()),
            Status: $('#Status').val(),
          });
          grid.updateRow(id, { 
            'ID': id,
            'Name': $('#Name').val(), 
            'SID': $('#SID').val(),
            'PNum': $('#PNum').val(),
            'Item': $('#Item').val(),
            'Get': $('#Get').val(),
            'Back': $('#Back').val(),
            'Remain': $('#Remain').val(),
            'Status': $('#Status').val(),
          });
        } else {
          db.collection('대여및반납').doc((grid.count(true)+1).toString()).set({
            Name: $('#Name').val(),
            SID: Number($('#SID').val()),
            PNum: $('#PNum').val(),
            Item: $('#Item').val(),
            Get: firebase.firestore.Timestamp.now(),
            Back: firebase.firestore.Timestamp.now(),
            Remain: Number($('#Remain').val()),
            Status: $('#Status').val(),
          });
          grid.addRow({ 
            'ID': grid.count(true) + 1, 
            'Name': $('#Name').val(), 
            'SID': Number($('#SID').val()),
            'PNum': $('#PNum').val(),
            'Item': $('#Item').val(),
            // 'Get': date_to_str(Date.now()),
            // 'Back': date_to_str(Date.now()),
            'Get': $('#Get').val(),
            'Back': $('#Back').val(),
            'Remain': Number($('#Remain').val()),
            'Status': $('#Status').val(),
          });
        }
        dialog.close();
      }
      $('#btnAdd').on('click', function () {
        $('#ID').val('');
        $('#Name').val('');
        $('#SID').val('');
        $('#PNum').val('');
        $('#Item').val('');
        $('#Get').val('');
        $('#Back').val('');
        $('#Remain').val('');
        $('#Status').val('');
        dialog.open('Add');
      });
      $('#btnSave').on('click', Save);
      $('#btnCancel').on('click', function () {
        dialog.close();
      });
      $('#btnSearch').on('click', function () {
        grid.reload({ page: 1, Name: $('#txtName').val(), PlaceOfBirth: $('#txtPlaceOfBirth').val() });
      });
      $('#btnClear').on('click', function () {
        $('#txtName').val('');
        $('#txtPlaceOfBirth').val('');
        grid.reload({ page: 1, Name: $('#txtName').val(), PlaceOfBirth: $('#txtPlaceOfBirth').val() });
      });
    })


    });
  </script>
</body>

</html>